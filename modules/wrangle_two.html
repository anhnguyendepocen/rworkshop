<!doctype html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="chrome=1">
<meta name="viewport" content="width=device-width">
<link rel="stylesheet" href="/rworkshop/assets/css/style.css">
<link rel="stylesheet" href="/rworkshop/assets/css/syntax_default.css">
<link rel="stylesheet" href="/rworkshop/assets/leaflet/leaflet.css" />
<script defer src="/rworkshop/assets/js/fontawesome-all.js"></script>
<!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->


  </head>
  <body>
    <div class="wrapper">
      <header>
        <h1>Workshop on R<a href="https://github.com/btskinner/rworkshop" class="iconlink">
	      <i class="fab fa-github fa-xs"></i></a></h1>
	<h2 class="thin">January 2018</h2>
	<p>Hosted by Virginia Education Science Training (VEST) Program at UVA</p>
	
        <p>
	  <a href="https://curry.virginia.edu/faculty-research/centers-labs-projects/edpolicyworks">
	    <img src="https://curry.virginia.edu/sites/default/files/uploads/epw/EdPolicyWork%20horz%20logo%20high%20res.png" style="width:100%;">
	  </a>
	</p>
	<h2 class="thin">
	  <a href="/rworkshop/">Overview</a></br>
	  <a href="/rworkshop/schedule/">Schedule</a></br>
	  <a href="/rworkshop/start/">Getting started</a></br>
	  <a href="/rworkshop/modules/">Modules</a></br>
	  <a href="/rworkshop/data/">Data</a></br>
	</h2>
      </header>

      <section>

      <h1>Wrangling data II</h1>


<p>
  <a href="/rworkshop/scripts/wrangle_two.R"
     class="iconlink" download title="Get script">
    <i class="fas fa-code fa-2x"></i>
  </a>
  &nbsp;&nbsp;
  
  <a href="/rworkshop/data/els_plans.csv"
     class="iconlink" download title="Get data">
    <i class="fas fa-database fa-2x"></i>
  </a>
  
</p>


<p>R has undergone a transformation in the past few years and this may
change how you choose to approach data wrangling. While the core R
functions for data manipulation haven’t really changed<sup id="fnref:1"><a href="#fn:1" class="footnote">1</a></sup>, a new suite
of packages, the <a href="https://www.tidyverse.org">tidyverse</a> (formerly known
as the “Hadleyverse” after their key creater, <a href="http://hadley.nz">Hadley
Wickham</a>), has really changed the way many people
approach using R.</p>

<p>In this module, I’m going to show you how to wrangle data the tidyverse
way. The sequence is almost the same as those in the last module. In the
end, it’s up to you which approach you prefer.</p>

<p>Data for this module are the same as those used in the last, from the
<a href="https://nces.ed.gov/surveys/els2002/">NCES Education Longitudinal Study of
2002</a>. For descriptions of the
variables, see the <a href="/rworkshop/data/#els_planscsv">codebook</a>. If you saved your cleaned up data
set using the same name, go ahead and download a fresh copy of the
original data.</p>

<h1 id="tidyverse">Tidyverse</h1>

<p>The tidyverse is a shorthand for a <a href="https://www.tidyverse.org/packages/">number of
packages</a> that work well together
and can be used in place of base R functions. A few of the tidyverse
packages that you will often use are:</p>

<ul>
  <li><a href="http://dplyr.tidyverse.org">dplyr</a> for data manipulation</li>
  <li><a href="http://tidyr.tidyverse.org">tidyr</a> for making data
<a href="http://vita.had.co.nz/papers/tidy-data.html">tidy</a></li>
  <li><a href="http://readr.tidyverse.org">readr</a> for flat file I/O</li>
  <li><a href="http://readxl.tidyverse.org">readxl</a> for Excel file I/O</li>
  <li><a href="http://haven.tidyverse.org">haven</a> for other file format I/O</li>
  <li><a href="http://ggplot2.tidyverse.org">ggplot2</a> for making graphics</li>
</ul>

<p>There are many others. A lot of R users find functions from these
libraries to be more intuitive than base R functions. In some cases,
tidyverse functions are faster than base R, which is an added benefit
when working with large data sets.</p>

<h2 id="magrittr-and-pipes">Magrittr and pipes</h2>

<p>The key feature of the tidyverse is its use of pipes, <code class="highlighter-rouge">%&gt;%</code>, from the
<a href="http://magrittr.tidyverse.org">magrittr package</a>.</p>

<p><span style="display:block;text-align:center">
<a href="https://www.fine-arts-museum.be/uploads/exhibitions/images/magritte_la_trahison_des_images_large@2x.jpg"><img src="https://www.rstudio.com/wp-content/uploads/2014/04/magrittr.png" alt="badge" /></a>
</span></p>

<p>Pipes take values/output from the left side and pipe it to the input of
the right side. So <code class="highlighter-rouge">sum(x)</code> can be rewritten as <code class="highlighter-rouge">x %&gt;% sum</code>. This is a
silly example (why would you do that?), but pipes are powerful because
they can be chained together. Nested layers of functions that would be
difficult to read from the inside out can be made clearer. Let’s use
<a href="https://twitter.com/_inundata/status/557980236130689024">Hadley’s canonical
example</a> to
make it clearer:</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">## foo_foo is an instance of a little bunny</span><span class="w">
</span><span class="n">foo_foo</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">little_bunny</span><span class="p">()</span><span class="w">

</span><span class="c1">## adventures in base R</span><span class="w">
</span><span class="n">bop_on</span><span class="p">(</span><span class="w">
    </span><span class="n">scoop_up</span><span class="p">(</span><span class="w">
        </span><span class="n">hop_through</span><span class="p">(</span><span class="n">foo_foo</span><span class="p">,</span><span class="w"> </span><span class="n">forest</span><span class="p">),</span><span class="w">
        </span><span class="n">field_mouse</span><span class="w">
    </span><span class="p">),</span><span class="w">
    </span><span class="n">head</span><span class="w">
</span><span class="p">)</span><span class="w">

</span><span class="c1">## adventures w/ pipes</span><span class="w">
</span><span class="n">foo_foo</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
    </span><span class="n">hop_through</span><span class="p">(</span><span class="n">forest</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
    </span><span class="n">scoop_up</span><span class="p">(</span><span class="n">field_mouse</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
    </span><span class="n">bop_on</span><span class="p">(</span><span class="n">head</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<h1 id="data-wrangling-with-tidyverse">Data wrangling with tidyverse</h1>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">## library</span><span class="w">
</span><span class="n">library</span><span class="p">(</span><span class="n">tidyverse</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>## ── Attaching packages ────────────────────────────────── tidyverse 1.2.1 ──

## ✔ ggplot2 2.2.1     ✔ purrr   0.2.4
## ✔ tibble  1.4.1     ✔ dplyr   0.7.4
## ✔ tidyr   0.7.2     ✔ stringr 1.2.0
## ✔ readr   1.1.1     ✔ forcats 0.2.0

## ── Conflicts ───────────────────────────────────── tidyverse_conflicts() ──
## ✖ dplyr::filter() masks stats::filter()
## ✖ dplyr::lag()    masks stats::lag()
</code></pre></div></div>

<p>Let’s reread the original data. Like <code class="highlighter-rouge">read.table()</code>, <code class="highlighter-rouge">read_delim()</code> is
the generic function that needs you to give it the separating/delimiting
character. You could also just use <code class="highlighter-rouge">read_csv()</code>.</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">## read in the data</span><span class="w">
</span><span class="n">df</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">read_delim</span><span class="p">(</span><span class="s1">'../data/els_plans.csv'</span><span class="p">,</span><span class="w"> </span><span class="n">delim</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">','</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>## Parsed with column specification:
## cols(
##   .default = col_character(),
##   stu_id = col_integer(),
##   sch_id = col_integer(),
##   strat_id = col_integer(),
##   f1sch_id = col_integer(),
##   bystuwt = col_double(),
##   bydob_p = col_integer(),
##   byses1 = col_double(),
##   byses2 = col_double(),
##   bynels2m = col_double(),
##   bynels2r = col_double(),
##   f1qwt = col_double(),
##   f1pnlwt = col_double()
## )

## See spec(...) for full column specifications.
</code></pre></div></div>

<h2 id="mutate">Mutate</h2>

<p>To add variables and change existing ones, use the <code class="highlighter-rouge">mutate()</code>.</p>

<p>Note that with this (and the following) tidyverse functions, you don’t
need to use the data frame name with the dollar sign construction and
you don’t need to put quotation marks around the column names.</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">## assign values inside function using = sign (not &lt;-)</span><span class="w">
</span><span class="n">df</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">df</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
    </span><span class="n">mutate</span><span class="p">(</span><span class="n">ones</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span><span class="p">,</span><span class="w">
           </span><span class="n">avg_test</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">bynels2r</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">bynels2m</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="m">2</span><span class="p">)</span><span class="w"> </span><span class="c1"># ignore neg vals</span><span class="w">
</span></code></pre></div></div>

<p>To conditionally mutate variables, use the <code class="highlighter-rouge">ifelse()</code> construction
inside the <code class="highlighter-rouge">mutate()</code> function.</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">## (1) make a numeric column that == 1 if bysex is female, 0 otherwise</span><span class="w">
</span><span class="c1">## (2) assign DOB an NA if &lt; 0</span><span class="w">
</span><span class="n">df</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">df</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
    </span><span class="n">mutate</span><span class="p">(</span><span class="n">female</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ifelse</span><span class="p">(</span><span class="n">bysex</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">'female'</span><span class="p">,</span><span class="w"> </span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="m">0</span><span class="p">),</span><span class="w">
           </span><span class="n">bydob_p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ifelse</span><span class="p">(</span><span class="n">bydob_p</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="m">0</span><span class="p">,</span><span class="w"> </span><span class="kc">NA</span><span class="p">,</span><span class="w"> </span><span class="n">bydob_p</span><span class="p">))</span><span class="w">           
</span></code></pre></div></div>

<blockquote>
  <h4 id="quick-exercise">Quick exercise</h4>

  <p>Create dummy variables for each race/ethnicity category in <code class="highlighter-rouge">byrace</code>.
(Hint: use (<code class="highlighter-rouge">table()</code>) to see the possible values; adv. hint:
<code class="highlighter-rouge">ifelse()</code> statements can be nested.)</p>
</blockquote>

<h2 id="select">Select</h2>

<p>To choose variables, either when making a new data frame or dropping
them, use <code class="highlighter-rouge">select()</code>. To drop them, use a negative sign (<code class="highlighter-rouge">-</code>) in front
of the variable name.</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">## drop follow up one panel weight</span><span class="w">
</span><span class="n">df</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">df</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> </span><span class="n">select</span><span class="p">(</span><span class="o">-</span><span class="n">f</span><span class="m">1</span><span class="n">pnlwt</span><span class="p">)</span><span class="w">

</span><span class="c1">## check names</span><span class="w">
</span><span class="nf">names</span><span class="p">(</span><span class="n">df</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>##  [1] "stu_id"   "sch_id"   "strat_id" "psu"      "f1sch_id" "bystuwt" 
##  [7] "bysex"    "byrace"   "bydob_p"  "bypared"  "bymothed" "byfathed"
## [13] "byincome" "byses1"   "byses2"   "bystexp"  "bynels2m" "bynels2r"
## [19] "f1qwt"    "f1psepln" "f2ps1sec" "ones"     "avg_test" "female"
</code></pre></div></div>

<blockquote>
  <h4 id="quick-exercise-1">Quick exercise</h4>

  <p>Without assigning back to your data frame (no <code class="highlighter-rouge">&lt;-</code>), see if you can
first keep a set of variables and then drop a set of variables. (Hint:
consider <code class="highlighter-rouge">c()</code>)</p>
</blockquote>

<h2 id="filter">Filter</h2>

<p>Like <code class="highlighter-rouge">select()</code> works on columns, <code class="highlighter-rouge">filter()</code> can be used to subset based
on row conditions. Earlier we properly labeled <code class="highlighter-rouge">bydob_p</code> values less
than zero as <code class="highlighter-rouge">NA</code>. Let’s drop those.</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">## show number of rows</span><span class="w">
</span><span class="n">nrow</span><span class="p">(</span><span class="n">df</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>## [1] 16160
</code></pre></div></div>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">## keep if not (!) missing</span><span class="w">
</span><span class="n">df</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">df</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> </span><span class="n">filter</span><span class="p">(</span><span class="o">!</span><span class="nf">is.na</span><span class="p">(</span><span class="n">bydob_p</span><span class="p">))</span><span class="w">
</span><span class="n">nrow</span><span class="p">(</span><span class="n">df</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>## [1] 15183
</code></pre></div></div>

<blockquote>
  <h4 id="quick-exercise-2">Quick exercise</h4>

  <p>Filter out observations if they are missing <code class="highlighter-rouge">bysex</code> values. You can do
it in two steps, first <code class="highlighter-rouge">mutate()</code>ing negative values to be <code class="highlighter-rouge">NA</code> and
then <code class="highlighter-rouge">filter()</code>ing out missing values, or in one step, just
<code class="highlighter-rouge">filter()</code>ing out if <code class="highlighter-rouge">bysex</code> has a value below zero.</p>
</blockquote>

<h2 id="arrange">Arrange</h2>

<p>Sort values using the <code class="highlighter-rouge">arrange()</code> function.</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">## show first few rows of student and base year math scores (tidyverse way)</span><span class="w">
</span><span class="n">df</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> </span><span class="n">select</span><span class="p">(</span><span class="n">stu_id</span><span class="p">,</span><span class="w"> </span><span class="n">bydob_p</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> </span><span class="n">head</span><span class="p">(</span><span class="m">10</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>## # A tibble: 10 x 2
##    stu_id bydob_p
##     &lt;int&gt;   &lt;int&gt;
##  1 101101  198512
##  2 101102  198605
##  3 101104  198601
##  4 101105  198607
##  5 101106  198511
##  6 101107  198510
##  7 101108  198607
##  8 101109  198512
##  9 101110  198505
## 10 101111  198507
</code></pre></div></div>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">## arrange</span><span class="w">
</span><span class="n">df</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">df</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> </span><span class="n">arrange</span><span class="p">(</span><span class="n">bydob_p</span><span class="p">)</span><span class="w">

</span><span class="c1">## show again first few rows of ID and DOB</span><span class="w">
</span><span class="n">df</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> </span><span class="n">select</span><span class="p">(</span><span class="n">stu_id</span><span class="p">,</span><span class="w"> </span><span class="n">bydob_p</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> </span><span class="n">head</span><span class="p">(</span><span class="m">10</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>## # A tibble: 10 x 2
##    stu_id bydob_p
##     &lt;int&gt;   &lt;int&gt;
##  1 133211  198300
##  2 195210  198300
##  3 195213  198300
##  4 225203  198300
##  5 268219  198300
##  6 268225  198300
##  7 274222  198300
##  8 280215  198300
##  9 324119  198300
## 10 327128  198300
</code></pre></div></div>

<blockquote>
  <h4 id="quick-exercise-3">Quick exercise</h4>

  <p><code class="highlighter-rouge">Arrange()</code> by <code class="highlighter-rouge">bydob_p</code> again, but this time in reverse order. Google
“dplyr arrange” to find information about the function and see if can
figure out how to sort in descending order.</p>
</blockquote>

<h2 id="summarize">Summarize</h2>

<p>Aggregate data using the <code class="highlighter-rouge">summarise()</code> or <code class="highlighter-rouge">summarize()</code> function
(they’re the same, just playing nice with by offering both spellings).
Unlike the <code class="highlighter-rouge">aggregate()</code> function, you first need to set the grouping
variable using the <code class="highlighter-rouge">group_by()</code> function. Since we need to replace
negative values before we summarize, we’ll chain a few functions
together into one command.</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">## create new data frame</span><span class="w">
</span><span class="n">sch_m</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">df</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
    </span><span class="c1">## first, make test score values &lt; 0 == NA</span><span class="w">
    </span><span class="n">mutate</span><span class="p">(</span><span class="n">bynels2m</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ifelse</span><span class="p">(</span><span class="n">bynels2m</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="m">0</span><span class="p">,</span><span class="w"> </span><span class="kc">NA</span><span class="p">,</span><span class="w"> </span><span class="n">bynels2m</span><span class="p">))</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
    </span><span class="c1">## group by school ID</span><span class="w">
    </span><span class="n">group_by</span><span class="p">(</span><span class="n">sch_id</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
    </span><span class="c1">## summarize</span><span class="w">
    </span><span class="n">summarise</span><span class="p">(</span><span class="n">sch_bynels2m</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mean</span><span class="p">(</span><span class="n">bynels2m</span><span class="p">,</span><span class="w"> </span><span class="n">na.rm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">TRUE</span><span class="p">))</span><span class="w">

</span><span class="c1">## show</span><span class="w">
</span><span class="n">sch_m</span><span class="w">
</span></code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>## # A tibble: 751 x 2
##    sch_id sch_bynels2m
##     &lt;int&gt;        &lt;dbl&gt;
##  1   1011         45.3
##  2   1012         43.3
##  3   1021         28.9
##  4   1022         38.6
##  5   1031         40.0
##  6   1032         35.3
##  7   1033         42.2
##  8   1041         44.9
##  9   1042         52.2
## 10   1051         45.9
## # ... with 741 more rows
</code></pre></div></div>

<blockquote>
  <h4 id="quick-exercise-4">Quick exercise</h4>

  <p>Find the average reading test score for each school and save it in an
object.</p>
</blockquote>

<p>The <code class="highlighter-rouge">group_by()</code> and <code class="highlighter-rouge">summarise()</code> functions are very useful for
generating summary statistics and exploring your data. We’ll use them
more in the modules on exploratory data analysis.</p>

<h2 id="join">Join</h2>

<p>Rather than saying “merge,” dplyr uses the SQL language of joins:</p>

<ul>
  <li><code class="highlighter-rouge">left_join(x, y)</code>: keep all x, drop unmatched y</li>
  <li><code class="highlighter-rouge">right_join(x, y)</code>: keep all y, drop unmatched x</li>
  <li><code class="highlighter-rouge">inner_join(x, y)</code>: keep only matching</li>
  <li><code class="highlighter-rouge">full_join(x, y)</code>: keep everything</li>
</ul>

<p><img src="/rworkshop/images/joins.png" alt="Joins" /></p>

<p>Since we want to join a smaller aggregated data frame to the original
data frame, we’ll use a <code class="highlighter-rouge">left_join()</code>. The join functions will try to
guess the joining variable (and tell you what it picked) if you don’t
supply one, but we’ll specify one to be clear.</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">## join on school ID variable</span><span class="w">
</span><span class="n">df</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">df</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> </span><span class="n">left_join</span><span class="p">(</span><span class="n">sch_m</span><span class="p">,</span><span class="w"> </span><span class="n">by</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'sch_id'</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<blockquote>
  <h4 id="quick-exercise-5">Quick exercise</h4>

  <p>Join the average reading test score data frame you made to the main
data object.</p>
</blockquote>

<h2 id="write">Write</h2>

<p>The readr library can also write delimited flat files. Instead of
<code class="highlighter-rouge">write_delim()</code>, we’ll use the wrapper function <code class="highlighter-rouge">write_csv()</code> to save a
csv file.</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">write_csv</span><span class="p">(</span><span class="n">df</span><span class="p">,</span><span class="w"> </span><span class="s1">'../data/els_plans_mod_tv.csv'</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<h1 id="reshaping-data">Reshaping data</h1>

<p>Reshaping data is a common data wrangling task. Whether going from wide
to long format or the reverse, this can be a painful process. The best
way I know to reshape data in R is by using the <strong>tidyr</strong> library.</p>

<h2 id="create-toy-data">Create toy data</h2>

<p>For clarity, we’ll use toy data for this example. It will be wide to
start.</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">df</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">data.frame</span><span class="p">(</span><span class="n">schid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="s1">'A'</span><span class="p">,</span><span class="s1">'B'</span><span class="p">,</span><span class="s1">'C'</span><span class="p">,</span><span class="s1">'D'</span><span class="p">),</span><span class="w">
                 </span><span class="n">year</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">2013</span><span class="p">,</span><span class="w">
                 </span><span class="n">var_x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span><span class="o">:</span><span class="m">4</span><span class="p">,</span><span class="w">
                 </span><span class="n">var_y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">5</span><span class="o">:</span><span class="m">8</span><span class="p">,</span><span class="w">
                 </span><span class="n">var_z</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">9</span><span class="o">:</span><span class="m">12</span><span class="p">,</span><span class="w">
                 </span><span class="n">stringsAsFactors</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">FALSE</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
    </span><span class="n">tbl_df</span><span class="p">()</span><span class="w">

</span><span class="c1">## show</span><span class="w">
</span><span class="n">df</span><span class="w">
</span></code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>## # A tibble: 4 x 5
##   schid  year var_x var_y var_z
##   &lt;chr&gt; &lt;dbl&gt; &lt;int&gt; &lt;int&gt; &lt;int&gt;
## 1 A      2013     1     5     9
## 2 B      2013     2     6    10
## 3 C      2013     3     7    11
## 4 D      2013     4     8    12
</code></pre></div></div>

<h2 id="wide--long">Wide –&gt; long</h2>

<p>To go from wide to long format, use the <code class="highlighter-rouge">gather(key, value)</code> function,
where the <code class="highlighter-rouge">key</code> is the variable that will made long (the stub in Stata)
and the <code class="highlighter-rouge">value</code> is the column of associated values that will be created.
Since we want the <strong>schid</strong> and <strong>year</strong> columns to remain associated
with their rows, we ignore them (<code class="highlighter-rouge">-c(...)</code>) so they will be repeated as
necessary.</p>

<p>Finally we <code class="highlighter-rouge">arrange()</code> the data by school ID and the variable name.</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">df_long</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">df</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
    </span><span class="n">gather</span><span class="p">(</span><span class="n">var</span><span class="p">,</span><span class="w"> </span><span class="n">value</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="nf">c</span><span class="p">(</span><span class="n">schid</span><span class="p">,</span><span class="w"> </span><span class="n">year</span><span class="p">))</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
    </span><span class="n">arrange</span><span class="p">(</span><span class="n">schid</span><span class="p">,</span><span class="w"> </span><span class="n">var</span><span class="p">)</span><span class="w">

</span><span class="c1">## show</span><span class="w">
</span><span class="n">df_long</span><span class="w">
</span></code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>## # A tibble: 12 x 4
##    schid  year var   value
##    &lt;chr&gt; &lt;dbl&gt; &lt;chr&gt; &lt;int&gt;
##  1 A      2013 var_x     1
##  2 A      2013 var_y     5
##  3 A      2013 var_z     9
##  4 B      2013 var_x     2
##  5 B      2013 var_y     6
##  6 B      2013 var_z    10
##  7 C      2013 var_x     3
##  8 C      2013 var_y     7
##  9 C      2013 var_z    11
## 10 D      2013 var_x     4
## 11 D      2013 var_y     8
## 12 D      2013 var_z    12
</code></pre></div></div>

<blockquote>
  <h4 id="quick-exercise-6">Quick exercise</h4>

  <p>What happens if you don’t include <code class="highlighter-rouge">-c(schid, year)</code> in the <code class="highlighter-rouge">gather()</code>
function? Try it.</p>
</blockquote>

<h2 id="long--wide">Long –&gt; wide</h2>

<p>To go in the opposite direction, use the <code class="highlighter-rouge">spread(var, value)</code> function,
which makes columns for every unique <code class="highlighter-rouge">var</code> and assigns the <code class="highlighter-rouge">value</code> that
was in the <code class="highlighter-rouge">var</code>s row. Unlike <code class="highlighter-rouge">gather()</code>, we don’t have explicily say to
ignore columns that want to ignore.</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">df_wide</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">df_long</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
    </span><span class="n">spread</span><span class="p">(</span><span class="n">var</span><span class="p">,</span><span class="w"> </span><span class="n">value</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
    </span><span class="n">arrange</span><span class="p">(</span><span class="n">schid</span><span class="p">)</span><span class="w">

</span><span class="c1">## show</span><span class="w">
</span><span class="n">df_wide</span><span class="w">
</span></code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>## # A tibble: 4 x 5
##   schid  year var_x var_y var_z
##   &lt;chr&gt; &lt;dbl&gt; &lt;int&gt; &lt;int&gt; &lt;int&gt;
## 1 A      2013     1     5     9
## 2 B      2013     2     6    10
## 3 C      2013     3     7    11
## 4 D      2013     4     8    12
</code></pre></div></div>

<p>In theory, our new <code class="highlighter-rouge">df_wide</code> data frame should be the same as the one we
started with. Let’s check:</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">## confirm that df_wide == df</span><span class="w">
</span><span class="n">identical</span><span class="p">(</span><span class="n">df</span><span class="p">,</span><span class="w"> </span><span class="n">df_wide</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>## [1] TRUE
</code></pre></div></div>

<p>Success!<sup id="fnref:2"><a href="#fn:2" class="footnote">2</a></sup></p>

<blockquote>
  <h4 id="quick-exercise-7">Quick exercise</h4>

  <p>Reshape this long data frame wide and then back:</p>

  <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>df &lt;- data.frame(id = rep(c('A','B','C','D'), each = 4),
                 year = paste0('y', rep(2000:2003, 4)),
                 test_score = rnorm(16),
                 stringsAsFactors = FALSE) %&gt;%
      tbl_df()
</code></pre></div>  </div>
</blockquote>

<h1 id="notes">Notes</h1>

<div class="footnotes">
  <ol>
    <li id="fn:1">
      <p>Except maybe under the hood in a few cases.&nbsp;<a href="#fnref:1" class="reversefootnote">&#8617;</a></p>
    </li>
    <li id="fn:2">
      <p>For a slightly more complicated version that uses <a href="https://stat.ethz.ch/R-manual/R-devel/library/base/html/regex.html">regular
expressions</a>
to adjust the variable names and values after each reshape, see this
<a href="https://gist.github.com/btskinner/a1f5bc5c1c32b48d4f45b05d2531e423">gist</a>&nbsp;<a href="#fnref:2" class="reversefootnote">&#8617;</a></p>
    </li>
  </ol>
</div>



      </section>
      <footer>
        <p>
  Benjamin Skinner</br>  
  Research Assistant Professor of Education</br>  
  University of Virginia</br>  
  <a href="https://www.btskinner.me" class="iconlink">
    <i class="fas fa-home fa-lg"></i></a> | 
  <a href="https://github.com/btskinner" class="iconlink">
    <i class="fab fa-github fa-lg"></i></a> | 
  <a href="mailto:btskinner@virginia.edu" class="iconlink">
    <i class="far fa-envelope fa-lg"></i></a> | 
  <a href="https://twitter.com/btskinner" class="iconlink">
    <i class="fab fa-twitter fa-lg"></i></a>
</p>
<p><small>Hosted on GitHub Pages &mdash; Theme by <a href="https://github.com/orderedlist">orderedlist</a></small></p>

      </footer>
    </div>
    <script src="/rworkshop/assets/js/scale.fix.js"></script>

    
    
    
    

    
    <script>
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
        ga('create', 'UA-63981025-1', 'auto');
        ga('send', 'pageview');
    </script>
  
  </body>
</html>
